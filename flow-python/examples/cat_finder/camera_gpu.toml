main = "cat_finder_camera"

[[nodes]]
name = "det"
ty = "Detect"
model = "yolox-s"
conf = 0.25
nms = 0.45
tsize = 640
path = "models/cat_finder_models/yolox_s.mge"
interval = 5
visualize = 1
device = "gpu"
device_id = 0

[[nodes]]
name = "reid_video"
ty = "ReIDVideo"
path = "models/cat_finder_models/resnet50.mge"
device = "gpu"
device_id = 0

[[nodes]]
name = "redis_proxy"
ty = "RedisProxy"
ip = "127.0.0.1"
port = "6379"
mode = "search"
prefix = "feature."


[[graphs]]
name = "subgraph"
inputs = [{ name = "inp", cap = 16, ports = ["det:inp"] }]
outputs = [{ name = "out", cap = 16, ports = ["redis_proxy:out"] }]
connections = [
#   # default
#   { cap = 16, ports = ["det:out", "track:inp"] },
#   { cap = 16, ports = ["track:out", "shaper:inp"] },
#   { cap = 16, ports = ["shaper:out", "reid_video:inp"] },
#   { cap = 16, ports = ["reid_video:out", "redis_proxy:inp"] },

  # Custom
  { cap = 16, ports = ["det:out", "track:inp"] },
  { cap = 16, ports = ["track:out", "display:inp"] },
  { cap = 16, ports = ["display:out", "shaper:inp"] },
  { cap = 16, ports = ["shaper:out", "reid_video:inp"] },
  { cap = 16, ports = ["reid_video:out", "redis_proxy:inp"] },
]

    [[graphs.nodes]]
    name = "display"
    ty = "Display"
    show_img = 1

    [[graphs.nodes]]
    name = "track"
    ty = "Track"

    [[graphs.nodes]]
    name = "shaper"
    ty = "ShaperINV"
    mode = "BEST"


[[graphs]]
name = "cat_finder_camera"
connections = [
  { cap = 16, ports = ["source:out", "destination:inp"] },
  { cap = 16, ports = ["source:inp", "destination:out"] }
]

    [[graphs.nodes]]
    name = "source"
    ty = "Capture"
    cap_id = "/home/rcxxx/Videos/two-cat-02.mp4"

    [[graphs.nodes]]
    name = "destination"
    ty = "subgraph"
